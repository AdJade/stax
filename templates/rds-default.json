{"AWSTemplateFormatVersion":"2010-09-09","Description":"Creates RDS instance with two private subnets and an DBSecurity group in a existing VPC","Parameters":{"Environment":{"Default":"test","MinLength":"1","Description":"Description of deployment environment, e. g., test or production","ConstraintDescription":"Can contain only alphanumeric characters, spaces, dashes and underscores.","AllowedPattern":"[-_ a-zA-Z0-9]*","MaxLength":"64","Type":"String"},"DBInstanceClass":{"Default":"db.m3.medium","Description":"RDS database instance class","ConstraintDescription":"Must be a valid RDS instance type.","AllowedValues":["db.t1.micro","db.m1.small","db.m1.medium","db.m1.large","db.m1.xlarge","db.m2.xlarge","db.m2.2xlarge","db.m2.4xlarge","db.m3.medium","db.m3.large","db.m3.xlarge","db.m3.2xlarge","db.r3.large","db.r3.xlarge","db.r3.2xlarge","db.r3.4xlarge","db.r3.8xlarge","db.t2.micro","db.t2.small","db.t2.medium"],"Type":"String"},"Engine":{"Description":"Database engine to use","Default":"postgres","Type":"String"},"DBSubnet2Cidr":{"Description":"CIDR address range for the private subnet to be created in the second AZ","Default":"10.183.101.0/24","Type":"String"},"DBName":{"Description":"Name of the database to create","Type":"String"},"App":{"Default":"REPLACE APP","MinLength":"1","Description":"Name for this ecosystem of services","ConstraintDescription":"Can contain only alphanumeric characters, spaces, dashes and underscores.","AllowedPattern":"[-_ a-zA-Z0-9]*","MaxLength":"64","Type":"String"},"AllocatedStorage":{"Description":"Amount of storage to allocate to database","Default":"5","Type":"String"},"MasterUsername":{"Description":"Master username for database","Type":"String"},"Group":{"Default":"REPLACE GROUP","MinLength":"1","Description":"Group responsible for this ecosystem of services","ConstraintDescription":"Can contain only alphanumeric characters, spaces, dashes and underscores.","AllowedPattern":"[-_ a-zA-Z0-9]*","MaxLength":"64","Type":"String"},"ServiceSGID":{"Description":"Security Group for service instances","Type":"String"},"DBSubnet1Cidr":{"Description":"CIDR address range for the private subnet to be created in the second AZ","Default":"10.183.100.0/24","Type":"String"},"MasterUserPassword":{"Description":"Master user password for database","Type":"String"},"KeepAlive":{"Default":"false","MinLength":"4","Description":"Boolean to indicate whether to allow resource to be kept alive during nightly reaping","ConstraintDescription":"Value should be 'true' or 'false'","AllowedValues":["true","false"],"MaxLength":"5","Type":"String"},"CostCenter":{"Default":"0000-0000-ABC00000","MinLength":"18","Description":"Cost center to be charged for this ecosystem of services","ConstraintDescription":"Format for cost center is ####-####-XYZ#####","AllowedPattern":"\\d{4}-\\d{4}-[A-Z]{3}\\d{5}","MaxLength":"18","Type":"String"},"VPCID":{"Description":"ID of VPC in which to create RDS instance","Type":"String"},"Owner":{"Default":"REPLACE OWNER","MinLength":"1","Description":"Individual responsible for this ecosystem of services","ConstraintDescription":"Can contain only alphanumeric characters, spaces, dashes and underscores.","AllowedPattern":"[-_ a-zA-Z0-9]*","MaxLength":"64","Type":"String"}},"Resources":{"DBInstance":{"Type":"AWS::RDS::DBInstance","Properties":{"DBInstanceClass":{"Ref":"DBInstanceClass"},"Engine":{"Ref":"Engine"},"MultiAZ":true,"DBName":{"Ref":"DBName"},"AllocatedStorage":{"Ref":"AllocatedStorage"},"DBInstanceIdentifier":{"Fn::Join":["-",["db-instance",{"Ref":"AWS::StackName"}]]},"VPCSecurityGroups":[{"Ref":"RDSSecurityGroup"}],"BackupRetentionPeriod":"7","MasterUsername":{"Ref":"MasterUsername"},"DBSubnetGroupName":{"Ref":"DBSubnetGroup"},"MasterUserPassword":{"Ref":"MasterUserPassword"},"StorageType":"gp2","Tags":[{"Key":"Name","Value":{"Fn::Join":["-",["dbinstance",{"Ref":"AWS::StackName"}]]}},{"Key":"App","Value":{"Ref":"App"}},{"Key":"Group","Value":{"Ref":"Group"}},{"Key":"Owner","Value":{"Ref":"Owner"}},{"Key":"Environment","Value":{"Ref":"Environment"}},{"Key":"KeepAlive","Value":{"Ref":"KeepAlive"}},{"Key":"CostCenter","Value":{"Ref":"CostCenter"}}]}},"RDSSecurityGroup":{"Type":"AWS::EC2::SecurityGroup","Properties":{"SecurityGroupIngress":[{"IpProtocol":"tcp","SourceSecurityGroupId":{"Ref":"ServiceSGID"},"FromPort":"5432","ToPort":"5432"}],"GroupDescription":"Rules for allowing access to RDS nodes","Tags":[{"Key":"Name","Value":{"Fn::Join":["-",["rds-sg",{"Ref":"AWS::StackName"}]]}},{"Key":"App","Value":{"Ref":"App"}},{"Key":"Group","Value":{"Ref":"Group"}},{"Key":"Owner","Value":{"Ref":"Owner"}},{"Key":"Environment","Value":{"Ref":"Environment"}},{"Key":"KeepAlive","Value":{"Ref":"KeepAlive"}},{"Key":"CostCenter","Value":{"Ref":"CostCenter"}}],"VpcId":{"Ref":"VPCID"}}},"DBSubnetGroup":{"Type":"AWS::RDS::DBSubnetGroup","Properties":{"DBSubnetGroupDescription":"DB Subnet Group","SubnetIds":[{"Ref":"DBPriSubnet1"},{"Ref":"DBPriSubnet2"}],"Tags":[{"Key":"Network","Value":"Private"},{"Key":"Name","Value":{"Fn::Join":["-",["dbprivsubnetgroup",{"Ref":"AWS::StackName"}]]}},{"Key":"App","Value":{"Ref":"App"}},{"Key":"Group","Value":{"Ref":"Group"}},{"Key":"Owner","Value":{"Ref":"Owner"}},{"Key":"Environment","Value":{"Ref":"Environment"}},{"Key":"KeepAlive","Value":{"Ref":"KeepAlive"}},{"Key":"CostCenter","Value":{"Ref":"CostCenter"}}]}},"DBPriSubnet1":{"Type":"AWS::EC2::Subnet","Properties":{"CidrBlock":{"Ref":"DBSubnet1Cidr"},"AvailabilityZone":"us-east-1a","Tags":[{"Key":"Network","Value":"Private"},{"Key":"Name","Value":{"Fn::Join":["-",["dbprivsubnet1",{"Ref":"AWS::StackName"}]]}},{"Key":"App","Value":{"Ref":"App"}},{"Key":"Group","Value":{"Ref":"Group"}},{"Key":"Owner","Value":{"Ref":"Owner"}},{"Key":"Environment","Value":{"Ref":"Environment"}},{"Key":"KeepAlive","Value":{"Ref":"KeepAlive"}},{"Key":"CostCenter","Value":{"Ref":"CostCenter"}}],"VpcId":{"Ref":"VPCID"}}},"DBPriSubnet2":{"Type":"AWS::EC2::Subnet","Properties":{"CidrBlock":{"Ref":"DBSubnet2Cidr"},"AvailabilityZone":"us-east-1b","Tags":[{"Key":"Network","Value":"Private"},{"Key":"Name","Value":{"Fn::Join":["-",["dbprivsubnet2",{"Ref":"AWS::StackName"}]]}},{"Key":"App","Value":{"Ref":"App"}},{"Key":"Group","Value":{"Ref":"Group"}},{"Key":"Owner","Value":{"Ref":"Owner"}},{"Key":"Environment","Value":{"Ref":"Environment"}},{"Key":"KeepAlive","Value":{"Ref":"KeepAlive"}},{"Key":"CostCenter","Value":{"Ref":"CostCenter"}}],"VpcId":{"Ref":"VPCID"}}}}}