{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "CoreOS on EC2: http://coreos.com/docs/running-coreos/cloud-providers/ec2/",
  "Parameters":{
    "DBName":{
      "Description" : "Boo",
      "Type" : "String"
    },
    "Engine":{
      "Description" : "Boo",
      "Type" : "String"
    },
    "VPCID":{
      "Description" : "Boo",
      "Type" : "String"
    },
    "ServiceSGID":{
      "Description" : "Boo",
      "Type" : "String"
    },
    "MasterUsername":{
      "Description" : "Boo",
      "Type" : "String"
    },
    "MasterUserPassword":{
      "Description" : "Boo",
      "Type" : "String"
    },
    "DBInstanceClass":{
      "Description" : "Boo",
      "Type" : "String"
    },
    "AllocatedStorage":{
      "Description" : "Boo",
      "Type" : "String"
    },
    "DBSubnet1Cidr":{
      "Description" : "Boo",
      "Type" : "String"
    },
    "DBSubnet2Cidr":{
      "Description" : "Boo",
      "Type" : "String"
    }
  },
  "Resources": {
    "DBSubnet1": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "AvailabilityZone": "us-east-1a",
        "CidrBlock": { "Ref": "DBSubnet1Cidr"},
        "Tags": [
          {"Key":"Name", "Value":"DBSubnet1"},
          {"Key":"Type", "Value":"db"},
          {"Key":"Group", "Value":"ITSA"},
          {"Key":"Env", "Value":"TEST"}
        ],
        "VpcId": {"Ref":"VPCID"}
      }
    },
    "DBSubnet2": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "AvailabilityZone": "us-east-1b",
        "CidrBlock": { "Ref": "DBSubnet2Cidr"},
        "Tags": [
              {"Key":"Name", "Value":"DBSubnet2"},
              {"Key":"Type", "Value":"db"},
              {"Key":"Group", "Value":"ITSA"},
              {"Key":"Env", "Value":"TEST"}
        ],
        "VpcId": {"Ref":"VPCID"}
      }
    },
    "DBSubnetGroup": {
      "Type": "AWS::RDS::DBSubnetGroup",
      "Properties": {
        "DBSubnetGroupDescription": "DB Subnet Group",
        "SubnetIds": [
          {
            "Ref": "DBSubnet1"
          },
          {
            "Ref": "DBSubnet2"
          }
        ],
        "Tags": [
              {"Key":"Name", "Value":"DBSubnetGroup"},
              {"Key":"Type", "Value":"db"},
              {"Key":"Group", "Value":"ITSA"},
              {"Key":"Env", "Value":"TEST"}
        ]
      }
    },
    "RDSSecurityGroup": {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : {
        "GroupDescription" : "VPC Security Group for RDS",
        "SecurityGroupEgress" : [ {
            "IpProtocol" : "tcp",
            "FromPort" : "5432",
            "ToPort" : "5432",
            "DestinationSecurityGroupId": {"Ref":"ServiceSGID"}
        }],
        "SecurityGroupIngress" : [{
            "IpProtocol" : "tcp",
            "FromPort" : "5432",
            "ToPort" : "5432",
            "SourceSecurityGroupId": {"Ref":"ServiceSGID"}
        }],
        "Tags": [
              {"Key":"Name", "Value":"RDSSecurityGroup"},
              {"Key":"Type", "Value":"sg"},
              {"Key":"Group", "Value":"ITSA"},
              {"Key":"Env", "Value":"TEST"}
        ],
        "VpcId" : {"Ref":"VPCID"}
      }
    },
    "DBInstance": {
      "Type": "AWS::RDS::DBInstance",
      "Properties": {
        "DBName": {"Ref":"DBName"},
        "Engine": {"Ref":"Engine"},
        "MultiAZ": "true",
        "MasterUsername": {"Ref":"MasterUsername"},
        "MasterUserPassword": {"Ref":"MasterUserPassword"},
        "DBInstanceClass": {"Ref":"DBInstanceClass"},
        "AllocatedStorage": {"Ref":"AllocatedStorage"},
        "DBSubnetGroupName": {
          "Ref": "DBSubnetGroup"
        },
        "VPCSecurityGroups": [
          { "Ref": "RDSSecurityGroup" }
        ],
        "Tags": [
              {"Key":"Role", "Value":"Primary"},
              {"Key":"Service", "Value":"MySvc"},
              {"Key":"Group", "Value":"ITSA"},
              {"Key":"Env", "Value":"TEST"}
        ]
      }
    },
    "SecurityGroupIngress":{
      "Type":"AWS::EC2::SecurityGroupIngress",
      "Properties":{
        "GroupId":{"Ref":"ServiceSGID"},
        "IpProtocol":"tcp",
        "FromPort":"5432",
        "ToPort":"5432",
        "SourceSecurityGroupId":{"Ref":"RDSSecurityGroup"}
      }
    }
  }
}
